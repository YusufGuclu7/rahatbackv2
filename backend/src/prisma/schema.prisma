generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int                     @id @default(autoincrement())
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @default(now()) @updatedAt
  deletedAt              DateTime?
  status                 Boolean                 @default(true)
  name                   String
  email                  String                  @unique
  password               String
  role                   Role                    @default(user)
  isEmailVerified        Boolean                 @default(false)
  twoFactorSecret        String?                 // Secret for 2FA (encrypted)
  twoFactorEnabled       Boolean                 @default(false)
  Database               Database[]
  Token                  Token[]
  NotificationSettings   NotificationSettings?
  CloudStorage           CloudStorage[]
  AuditLog               AuditLog[]
}

model Token {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt
  token       String
  type        TokenType
  userId      Int
  expiresAt   DateTime
  blacklisted Boolean   @default(false)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Database {
  id               Int             @id @default(autoincrement())
  userId           Int
  name             String
  type             DatabaseType
  host             String
  port             Int
  username         String
  password         String
  database         String
  connectionString String?
  sslEnabled       Boolean         @default(false)
  isActive         Boolean         @default(true)
  lastTestedAt     DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  BackupHistory    BackupHistory[]
  BackupJob        BackupJob[]
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BackupJob {
  id              Int             @id @default(autoincrement())
  databaseId      Int
  name            String
  scheduleType    ScheduleType
  cronExpression  String?
  isActive        Boolean         @default(true)
  storageType     StorageType
  storagePath     String
  cloudStorageId  Int?
  retentionDays   Int             @default(30)
  compression     Boolean         @default(true)
  isEncrypted     Boolean         @default(false)
  encryptionPasswordHash String?

  // Incremental & Differential backup fields
  backupType               BackupType      @default(full)
  lastFullBackupAt         DateTime?       // Last full backup timestamp
  lastDifferentialBackupAt DateTime?       // Last differential backup timestamp

  lastRunAt       DateTime?
  nextRunAt       DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  BackupHistory   BackupHistory[]
  database        Database        @relation(fields: [databaseId], references: [id], onDelete: Cascade)
  cloudStorage    CloudStorage?   @relation(fields: [cloudStorageId], references: [id], onDelete: SetNull)
}

model BackupHistory {
  id           Int          @id @default(autoincrement())
  backupJobId  Int?
  databaseId   Int
  status       BackupStatus
  backupType   BackupType   @default(full)
  baseBackupId Int?         // For incremental/differential: reference to the base full backup
  fileName     String
  fileSize     BigInt?
  filePath     String
  duration     Int?
  errorMessage String?
  isEncrypted  Boolean      @default(false)

  // Backup verification fields
  checksum            String?  // SHA256 checksum for file integrity
  verificationStatus  String?  // 'pending', 'verified', 'failed'
  verifiedAt          DateTime?
  canBeRestored       Boolean  @default(false) // Only true if verified

  startedAt    DateTime     @default(now())
  completedAt  DateTime?
  backupJob    BackupJob?   @relation(fields: [backupJobId], references: [id])
  database     Database     @relation(fields: [databaseId], references: [id], onDelete: Cascade)

  @@index([backupType])
  @@index([baseBackupId])
}

model NotificationSettings {
  id                      Int      @id @default(autoincrement())
  userId                  Int      @unique
  emailEnabled            Boolean  @default(true)
  dailySummaryEnabled     Boolean  @default(false)
  dailySummaryTime        String   @default("09:00")
  recipientEmail          String?
  notifyOnSuccess         Boolean  @default(true)
  notifyOnFailure         Boolean  @default(true)
  isActive                Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CloudStorage {
  id                    Int              @id @default(autoincrement())
  userId                Int
  name                  String
  storageType           StorageType
  isActive              Boolean          @default(true)
  isDefault             Boolean          @default(false)

  // AWS S3 Configuration
  s3Region              String?
  s3Bucket              String?
  s3AccessKeyId         String?          // Deprecated - use s3EncryptedCredentials
  s3SecretAccessKey     String?          // Deprecated - use s3EncryptedCredentials
  s3Endpoint            String?
  s3EncryptedCredentials String?         // New encrypted credentials field

  // Google Drive Configuration
  gdRefreshToken        String?
  gdFolderId            String?

  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  BackupJob             BackupJob[]
}

enum Role {
  user
  admin
}

enum TokenType {
  access
  refresh
  resetPassword
  verifyEmail
}

enum DatabaseType {
  postgresql
  mysql
  mongodb
  mssql
  mariadb
  sqlite
}

enum ScheduleType {
  manual
  hourly
  daily
  weekly
  monthly
  custom
}

enum StorageType {
  local
  s3
  google_drive
  ftp
  azure
}

enum BackupStatus {
  running
  success
  failed
  cancelled
}

enum BackupType {
  full
  incremental
  differential
}

enum AuditAction {
  // Authentication
  LOGIN
  LOGOUT
  REGISTER
  PASSWORD_RESET
  PASSWORD_CHANGE
  TWO_FACTOR_ENABLE
  TWO_FACTOR_DISABLE

  // Database
  DATABASE_CREATE
  DATABASE_UPDATE
  DATABASE_DELETE
  DATABASE_TEST

  // Backup Jobs
  BACKUP_JOB_CREATE
  BACKUP_JOB_UPDATE
  BACKUP_JOB_DELETE
  BACKUP_JOB_RUN

  // Backup History
  BACKUP_START
  BACKUP_SUCCESS
  BACKUP_FAIL
  BACKUP_DELETE
  BACKUP_DOWNLOAD
  BACKUP_RESTORE

  // Cloud Storage
  CLOUD_STORAGE_CREATE
  CLOUD_STORAGE_UPDATE
  CLOUD_STORAGE_DELETE
  CLOUD_STORAGE_TEST

  // Notifications
  NOTIFICATION_UPDATE
  NOTIFICATION_TEST

  // Users (Admin)
  USER_CREATE
  USER_UPDATE
  USER_DELETE

  // Settings
  SETTINGS_UPDATE
}

model AuditLog {
  id          Int          @id @default(autoincrement())
  userId      Int?
  action      AuditAction
  resource    String?      // e.g., "database", "backup_job", "cloud_storage"
  resourceId  Int?         // ID of the resource affected
  details     String?      @db.Text // JSON string with additional details
  ipAddress   String?
  userAgent   String?
  status      String       @default("success") // success, failed
  errorMessage String?     @db.Text
  createdAt   DateTime     @default(now())

  user        User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([resource, resourceId])
}
