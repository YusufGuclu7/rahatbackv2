generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int                     @id @default(autoincrement())
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @default(now()) @updatedAt
  deletedAt              DateTime?
  status                 Boolean                 @default(true)
  name                   String
  email                  String                  @unique
  password               String
  role                   Role                    @default(user)
  isEmailVerified        Boolean                 @default(false)
  Database               Database[]
  Token                  Token[]
  NotificationSettings   NotificationSettings?
  CloudStorage           CloudStorage[]
}

model Token {
  id          Int       @id @default(autoincrement())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt
  token       String
  type        TokenType
  userId      Int
  expiresAt   DateTime
  blacklisted Boolean   @default(false)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Database {
  id               Int             @id @default(autoincrement())
  userId           Int
  name             String
  type             DatabaseType
  host             String
  port             Int
  username         String
  password         String
  database         String
  connectionString String?
  sslEnabled       Boolean         @default(false)
  isActive         Boolean         @default(true)
  lastTestedAt     DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  BackupHistory    BackupHistory[]
  BackupJob        BackupJob[]
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model BackupJob {
  id              Int             @id @default(autoincrement())
  databaseId      Int
  name            String
  scheduleType    ScheduleType
  cronExpression  String?
  isActive        Boolean         @default(true)
  storageType     StorageType
  storagePath     String
  cloudStorageId  Int?
  retentionDays   Int             @default(30)
  compression     Boolean         @default(true)
  lastRunAt       DateTime?
  nextRunAt       DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  BackupHistory   BackupHistory[]
  database        Database        @relation(fields: [databaseId], references: [id], onDelete: Cascade)
  cloudStorage    CloudStorage?   @relation(fields: [cloudStorageId], references: [id], onDelete: SetNull)
}

model BackupHistory {
  id           Int          @id @default(autoincrement())
  backupJobId  Int?
  databaseId   Int
  status       BackupStatus
  fileName     String
  fileSize     BigInt?
  filePath     String
  duration     Int?
  errorMessage String?
  startedAt    DateTime     @default(now())
  completedAt  DateTime?
  backupJob    BackupJob?   @relation(fields: [backupJobId], references: [id])
  database     Database     @relation(fields: [databaseId], references: [id], onDelete: Cascade)
}

model NotificationSettings {
  id                      Int      @id @default(autoincrement())
  userId                  Int      @unique
  emailEnabled            Boolean  @default(true)
  dailySummaryEnabled     Boolean  @default(false)
  dailySummaryTime        String   @default("09:00")
  recipientEmail          String?
  notifyOnSuccess         Boolean  @default(true)
  notifyOnFailure         Boolean  @default(true)
  isActive                Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CloudStorage {
  id                    Int              @id @default(autoincrement())
  userId                Int
  name                  String
  storageType           StorageType
  isActive              Boolean          @default(true)
  isDefault             Boolean          @default(false)

  // AWS S3 Configuration
  s3Region              String?
  s3Bucket              String?
  s3AccessKeyId         String?          // Deprecated - use s3EncryptedCredentials
  s3SecretAccessKey     String?          // Deprecated - use s3EncryptedCredentials
  s3Endpoint            String?
  s3EncryptedCredentials String?         // New encrypted credentials field

  // Google Drive Configuration
  gdRefreshToken        String?
  gdFolderId            String?

  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  BackupJob             BackupJob[]
}

enum Role {
  user
  admin
}

enum TokenType {
  access
  refresh
  resetPassword
  verifyEmail
}

enum DatabaseType {
  postgresql
  mysql
  mongodb
  mssql
  mariadb
  sqlite
}

enum ScheduleType {
  manual
  hourly
  daily
  weekly
  monthly
  custom
}

enum StorageType {
  local
  s3
  google_drive
  ftp
  azure
}

enum BackupStatus {
  running
  success
  failed
  cancelled
}
